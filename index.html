<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>班级未上交统计小工具（网页版）</title>
  <!-- SheetJS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body{font-family: -apple-system,BlinkMacSystemFont,'Segoe UI','Noto Sans SC',Roboto,'Helvetica Neue',Arial; padding:12px; max-width:980px;margin:0 auto}
    header{display:flex;align-items:center;gap:12px}
    h1{font-size:20px;margin:6px 0}
    .card{border:1px solid #e6e6e6;border-radius:8px;padding:12px;margin:10px 0;box-shadow:0 1px 4px rgba(0,0,0,0.03)}
    label{display:block;margin:8px 0 6px}
    input[type=file]{display:block}
    .row{display:flex;gap:8px;flex-wrap:wrap}
    button{padding:8px 12px;border-radius:8px;border:1px solid #ccc;background:#f7f7f7;cursor:pointer}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{border:1px solid #eee;padding:6px;text-align:left;font-size:13px}
    .small{font-size:12px;color:#666}
    @media (max-width:600px){.row{flex-direction:column}}
  </style>
</head>
<body>
  <header>
    <h1>班级未上交统计小工具（网页版）</h1>
  </header>

  <div class="card">
    <strong>说明：</strong> 支持上传任意班级名单（Excel）、已上交名单（Excel 或 粘贴文本），按姓名或学号匹配，支持多个项目、多任务统计，结果可下载为 Excel 或复制未交名单。数据可保存在本地浏览器。
  </div>

  <div class="card">
    <label>1) 上传/加载班级名单（Excel，含姓名/学号列）</label>
    <input id="classFile" type="file" accept=".xls,.xlsx" />
    <div class="small">或者直接加载你之前上传的样本： <button id="loadSample">加载示例班级名单</button>（后台路径：/mnt/data/4班名单.xlsx）</div>
    <div id="classPreview"></div>
  </div>

  <div class="card">
    <label>2) 添加/选择任务（项目）</label>
    <div class="row">
      <input id="taskName" placeholder="任务名称（例如：作业1）" />
      <button id="addTask">添加任务</button>
      <select id="taskList"></select>
      <button id="deleteTask">删除当前任务</button>
    </div>
    <div class="small">提示：同一班级可创建多个任务（作业1、作业2、打卡等）。</div>
  </div>

  <div class="card">
    <label>3) 上交名单输入（可上传 Excel，或粘贴名单，支持姓名或学号）</label>
    <div class="row">
      <input id="submittedFile" type="file" accept=".xls,.xlsx,.csv" />
      <button id="pasteMode">粘贴名单模式</button>
      <button id="pasteFromClipboard">从剪贴板粘贴（手机可能需允许）</button>
    </div>
    <textarea id="pasteArea" style="width:100%;height:84px;margin-top:8px;display:none" placeholder="在此粘贴已上交的姓名或学号，每行一个，或以逗号/空格分隔"></textarea>
    <div style="margin-top:8px">
      匹配方式：
      <label><input type="radio" name="matchBy" value="name" checked /> 姓名</label>
      <label><input type="radio" name="matchBy" value="id" /> 学号</label>
    </div>
  </div>

  <div class="card">
    <button id="compare">开始比对（生成结果）</button>
    <button id="downloadResult">下载未交名单 Excel</button>
    <button id="copyMissing">复制未交名单</button>
    <div id="stats" class="small" style="margin-top:8px"></div>
  </div>

  <div class="card">
    <h3>结果预览</h3>
    <div id="resultArea"></div>
  </div>

<script>
// 状态
let classList = []; // {姓名, 学号, ...}
let tasks = {}; // taskName -> {submitted: Set(), missing: []}
let currentTask = null;

// util: parse excel file to array of objects
function parseExcelFile(file, cb){
  const reader = new FileReader();
  reader.onload = function(e){
    const data = new Uint8Array(e.target.result);
    const workbook = XLSX.read(data, {type:'array'});
    const first = workbook.SheetNames[0];
    const aoa = XLSX.utils.sheet_to_json(workbook.Sheets[first], {header:1});
    cb(aoa);
  };
  reader.readAsArrayBuffer(file);
}

function aoaToObjects(aoa){
  if(!aoa || aoa.length===0) return [];
  const header = aoa[0].map(h=>String(h||\"`).trim());
  const rows = aoa.slice(1).map(r=>{
    const obj = {};
    for(let i=0;i<header.length;i++) obj[header[i]] = r[i]===undefined?\"\":String(r[i]).trim();
    return obj;
  });
  return {header, rows};
}

// Better header normalization
function pickNameAndId(row){
  const keys = Object.keys(row);
  let nameKey = keys.find(k=>/姓名|name/i.test(k)) || keys[0];
  let idKey = keys.find(k=>/学号|id|student/i.test(k));
  return {name: String(row[nameKey]||'').trim(), id: idKey?String(row[idKey]||'').trim():''};
}

function renderClassPreview(){
  const el = document.getElementById('classPreview');
  if(classList.length===0){ el.innerHTML='（尚未加载班级名单）'; return; }
  let html = `<div class=\"small\">共 ${classList.length} 人</div>`;
  html += '<table><thead><tr><th>姓名</th><th>学号</th></tr></thead><tbody>';
  classList.slice(0,200).forEach(r=> html += `<tr><td>${r.name||''}</td><td>${r.id||''}</td></tr>`);
  html += '</tbody></table>';
  el.innerHTML = html;
}

function addTask(name){
  if(!name) return alert('请输入任务名');
  if(tasks[name]) return alert('任务已存在');
  tasks[name] = {submitted: new Set(), missing: []};
  currentTask = name;
  saveState();
  refreshTaskList();
}

function refreshTaskList(){
  const sel = document.getElementById('taskList');
  sel.innerHTML='';
  Object.keys(tasks).forEach(t=>{
    const opt = document.createElement('option'); opt.value=t; opt.textContent=t; if(t===currentTask) opt.selected=true; sel.appendChild(opt);
  });
}

function saveState(){
  const st = {classList, tasks, currentTask};
  try{ localStorage.setItem('classToolState', JSON.stringify(st)); }catch(e){}
}
function loadState(){
  try{ const st = JSON.parse(localStorage.getItem('classToolState')); if(st){ classList=st.classList||[]; tasks=st.tasks||{}; currentTask=st.currentTask||Object.keys(tasks)[0]; }}catch(e){}
}

function buildMaps(){
  const nameMap = new Map(), idMap = new Map();
  classList.forEach(p=>{ if(p.name) nameMap.set(p.name, p); if(p.id) idMap.set(p.id, p); });
  return {nameMap, idMap};
}

function parsePlainTextNames(text){
  if(!text) return [];
  const lines = text.split(/[\n,，;；\t]+/).map(s=>s.trim()).filter(Boolean);
  return lines;
}

function compareNow(){
  if(classList.length===0) return alert('请先加载班级名单');
  if(!currentTask) return alert('请先创建并选择一个任务');
  // get submitted source
  let submitted = [];
  const fileInput = document.getElementById('submittedFile');
  const pasteArea = document.getElementById('pasteArea');
  const matchBy = document.querySelector('input[name="matchBy"]:checked').value;

  function doCompare(subArr){
    const {nameMap,idMap} = buildMaps();
    const submittedSet = new Set();
    if(matchBy==='name') subArr.forEach(s=> submittedSet.add(String(s).trim()));
    else subArr.forEach(s=> submittedSet.add(String(s).trim()));
    // mark submitted
    tasks[currentTask].submitted = submittedSet;
    const missing = [];
    classList.forEach(p=>{
      const key = matchBy==='name'?p.name:p.id;
      if(!key){ missing.push(p); return; }
      if(!submittedSet.has(key)) missing.push(p);
    });
    tasks[currentTask].missing = missing;
    renderResult(); saveState();
  }

  if(pasteArea.style.display!=='none' && pasteArea.value.trim()){
    const arr = parsePlainTextNames(pasteArea.value);
    doCompare(arr);
    return;
  }
  if(fileInput.files && fileInput.files.length>0){
    parseExcelFile(fileInput.files[0], aoa=>{
      const {header, rows} = aoaToObjects(aoa);
      // try to read name/id columns
      const objs = rows;
      const items = objs.map(r=>{
        // try to find name or id
        const colKeys = Object.keys(r);
        const valName = colKeys.find(k=>/姓名|name/i.test(k))||colKeys[0];
        const valId = colKeys.find(k=>/学号|id/i.test(k));
        return matchBy==='name'? String(r[valName]||'').trim() : (valId?String(r[valId]||'').trim():String(r[valName]||'').trim());
      }).filter(Boolean);
      doCompare(items);
    });
    return;
  }
  // nothing uploaded: use pasteArea if empty -> prompt
  alert('请上传已上交名单或使用粘贴模式输入名单');
}

function renderResult(){
  const area = document.getElementById('resultArea');
  const st = tasks[currentTask];
  if(!st){ area.innerHTML='（尚未有结果）'; return; }
  const total = classList.length;
  const submittedCount = st.submitted.size || (total - st.missing.length);
  const missingCount = st.missing.length;
  let html = `<div class=\"small\">任务：<strong>${currentTask}</strong> · 总人数 ${total} · 已交 ${submittedCount} · 未交 ${missingCount}</div>`;
  html += '<table><thead><tr><th>姓名</th><th>学号</th></tr></thead><tbody>';
  st.missing.forEach(p=> html += `<tr><td>${p.name||''}</td><td>${p.id||''}</td></tr>`);
  html += '</tbody></table>';
  area.innerHTML = html;
  document.getElementById('stats').textContent = `总 ${total} | 已交 ${submittedCount} | 未交 ${missingCount}`;
}

// download missing as excel
function downloadMissing(){
  if(!currentTask) return alert('请选择任务');
  const st = tasks[currentTask];
  if(!st) return alert('无结果');
  const aoa = [['姓名','学号']].concat(st.missing.map(p=>[p.name||'', p.id||'']));
  const ws = XLSX.utils.aoa_to_sheet(aoa);
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, '未上交');
  XLSX.writeFile(wb, `${currentTask}_未上交名单.xlsx`);
}

function copyMissingToClipboard(){
  if(!currentTask) return alert('请选择任务');
  const st = tasks[currentTask];
  if(!st) return alert('无结果');
  const text = st.missing.map(p=> (p.id? (p.name+" ("+p.id+")"):p.name)).join('\n');
  navigator.clipboard.writeText(text).then(()=> alert('已复制到剪贴板')).catch(()=> alert('复制失败，请手动选中复制'));
}

// load sample from server path (developer-provided path)
async function loadSampleFromPath(){
  try{
    const url = '/mnt/data/4班名单.xlsx'; // developer: path provided in conversation
    const resp = await fetch(url);
    if(!resp.ok) throw new Error('加载失败');
    const blob = await resp.blob();
    parseExcelFile(blob, aoa=>{
      const {header, rows} = aoaToObjects(aoa);
      classList = rows.map(r=> pickNameAndId(r));
      renderClassPreview(); saveState();
    });
  }catch(e){ alert('无法直接从服务器加载示例，请手动上传班级名单 Excel。\\n\\n错误：'+e.message); }
}

// events
window.addEventListener('load', ()=>{
  loadState(); renderClassPreview(); refreshTaskList(); renderResult();
  document.getElementById('classFile').addEventListener('change', e=>{
    const f = e.target.files[0]; if(!f) return;
    parseExcelFile(f, aoa=>{
      const {header, rows} = aoaToObjects(aoa);
      classList = rows.map(r=> pickNameAndId(r));
      renderClassPreview(); saveState();
    });
  });
  document.getElementById('loadSample').addEventListener('click', loadSampleFromPath);
  document.getElementById('addTask').addEventListener('click', ()=>{ const name=document.getElementById('taskName').value.trim(); if(name) addTask(name); });
  document.getElementById('taskList').addEventListener('change', e=>{ currentTask = e.target.value; saveState(); renderResult(); });
  document.getElementById('deleteTask').addEventListener('click', ()=>{ const sel=document.getElementById('taskList'); const name=sel.value; if(!name) return; if(!confirm('删除任务：'+name+'？')) return; delete tasks[name]; currentTask = Object.keys(tasks)[0]||null; refreshTaskList(); saveState(); renderResult(); });
  document.getElementById('pasteMode').addEventListener('click', ()=>{ const pa=document.getElementById('pasteArea'); pa.style.display = pa.style.display==='none'?'block':'none'; });
  document.getElementById('pasteFromClipboard').addEventListener('click', async ()=>{ try{ const text = await navigator.clipboard.readText(); document.getElementById('pasteArea').value = text; document.getElementById('pasteArea').style.display='block'; alert('已粘贴剪贴板内容到输入框'); }catch(e){ alert('无法读取剪贴板'); } });
  document.getElementById('submittedFile').addEventListener('change', ()=>{ alert('已选择提交文件，点击“开始比对”开始处理。'); });
  document.getElementById('compare').addEventListener('click', compareNow);
  document.getElementById('downloadResult').addEventListener('click', downloadMissing);
  document.getElementById('copyMissing').addEventListener('click', copyMissingToClipboard);
});
</script>
</body>
</html>
